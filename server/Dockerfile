

FROM node:lts-alpine as builder

ARG PORT
ARG NODE_ENV
ARG VERSION
ARG MONGO_PWD
ARG MONGO_DB
ARG EMAIL_USERNAME
ARG EMAIL_PASSWORD
ARG EMAIL_FROM
ARG EMAIL_HOST
ARG EMAIL_PORT
ARG EMAIL_CLIENT_ID
ARG EMAIL_CLIENT_SECRET
ARG EMAIL_REFRESH_TOKEN
ARG EMAIL_ACCESS_TOKEN
ARG JWT_SECRET
ARG JWT_EXPIRES_IN
ARG FACEBOOK_ID
ARG FACEBOOK_SECRET
ARG FACEBOOK_CALLBACK_URL
ARG AWS_BUCKET_NAME
ARG AWS_BUCKET_REGION
ARG AWS_ACCESS_KEY
ARG AWS_SECRET_KEY
ARG BASE_URL


ENV PORT=${PORT}
ENV NODE_ENV=${NODE_ENV}}
ENV VERSION=${VERSION}
ENV MONGO_PWD=${MONGO_PWD}
ENV MONGO_DB=${MONGO_DB}
ENV EMAIL_USERNAME=${EMAIL_USERNAME}
ENV EMAIL_PASSWORD=${EMAIL_PASSWORD}
ENV EMAIL_FROM=${EMAIL_FROM}
ENV EMAIL_HOST=${EMAIL_HOST}
ENV EMAIL_PORT=${EMAIL_PORT}
ENV EMAIL_CLIENT_ID=${EMAIL_CLIENT_ID}
ENV EMAIL_CLIENT_SECRET=${EMAIL_CLIENT_SECRET}
ENV EMAIL_REFRESH_TOKEN=${EMAIL_REFRESH_TOKEN}
ENV EMAIL_ACCESS_TOKEN=${EMAIL_ACCESS_TOKEN}
ENV JWT_SECRET=${JWT_SECRET}
ENV JWT_EXPIRES_IN=${JWT_EXPIRES_IN}
ENV FACEBOOK_ID=${FACEBOOK_ID}
ENV FACEBOOK_SECRET=${FACEBOOK_SECRET}
ENV FACEBOOK_CALLBACK_URL=${FACEBOOK_CALLBACK_URL}
ENV AWS_BUCKET_NAME=${AWS_BUCKET_NAME}
ENV AWS_BUCKET_REGION=${AWS_BUCKET_REGION}
ENV AWS_ACCESS_KEY=${AWS_ACCESS_KEY}
ENV AWS_SECRET_KEY=${AWS_SECRET_KEY}
ENV BASE_URL=${BASE_URL}

# Create app directory
WORKDIR /usr/src/app

# Install app dependencies
COPY package*.json ./

RUN npm ci

COPY . .

RUN npm run build

ENV NODE_ENV=prod

FROM node:lts-alpine

USER node

# Create app directory
WORKDIR /usr/src/app

# Install app dependencies
COPY package*.json ./

RUN npm ci --production

COPY --from=builder /usr/src/app/dist/ ./dist

EXPOSE 8000

CMD [ "npm", "run", "prod" ]